const transactionService = require('../services/transactionService');
const paymentService = require('../services/paymentService');
const facebookService = require('../services/facebookService');
const stateService = require('../services/stateService');
const Transaction = require('../models/Transaction');
const reportService = require('../services/reportService');

const handleWebhook = async (req, res) => {
  try {
    const body = req.body;

    // Facebook webhook verification
    if (body.object === 'page') {
      for (const entry of body.entry) {
        for (const event of entry.messaging) {
          await handleMessage(event);
        }
      }
      res.status(200).send('EVENT_RECEIVED');
    } 
    // Omise webhook
    else if (body.object === 'event') {
      await paymentService.handleWebhook(body);
      res.status(200).send('WEBHOOK_RECEIVED');
    }
    else {
      res.sendStatus(404);
    }
  } catch (error) {
    console.error('Webhook error:', error);
    res.sendStatus(500);
  }
};

const handleMessage = async (event) => {
  const senderId = event.sender.id;
  const message = event.message?.text?.trim();
  const postback = event.postback;
  const attachments = event.message?.attachments;

  if (postback) {
    await handlePostback(senderId, postback);
    return;
  }



  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö (‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô)
  if (attachments && attachments.length > 0) {
    await handlePaymentProof(senderId, attachments);
    return;
  }

  if (!message) return;

  try {
    await facebookService.markSeen(senderId);

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö state reporting_issue ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏≠‡∏∑‡πà‡∏ô‡πÜ
    const state = stateService.getState(senderId);
    if (state?.state === 'reporting_issue') {
      const transactionId = state.data?.transactionId;
      console.log('User is reporting issue for transaction:', transactionId);
      
      await reportService.startNewReport(senderId, message, transactionId);
      stateService.clearState(senderId); // ‡∏•‡πâ‡∏≤‡∏á state ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à
      return;
    }
    else if (message === '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏≤‡∏¢') {
      await transactionService.startSellerFlow(senderId);
    }
    else if (message.match(/^TX[A-Z0-9]/i)) {
      const transactionId = message.toUpperCase();
      const transactionExists = await Transaction.findOne({ transactionId });
      
      if (transactionExists) {
        await transactionService.handleBuyerJoin(senderId, transactionId);
      } else {
        await facebookService.sendMessage(senderId, 
          `‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏° ID: ${transactionId} ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö\n\n` +
          `üí° ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å Transaction ID ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà`
        );
      }
    }
    else if (message.startsWith('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô ')) {
      const transactionId = message.replace('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô ', '').trim();
      await transactionService.handlePaymentConfirmation(senderId, transactionId);
    }

    else if (message.startsWith('/report')) {
      const reportMessage = message.replace('/report', '').trim();
      if (!reportMessage) {
        await facebookService.sendMessage(
          senderId, 
          '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á /report\n\n' +
          'üí° ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: /report ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ'
        );
        return;
      }
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö transactionId ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á
      let transactionId = null;
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å state ‡∏Å‡πà‡∏≠‡∏ô (‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
      const userState = stateService.getState(senderId);
      if (userState && userState.data && userState.data.transactionId) {
        transactionId = userState.data.transactionId;
        console.log('Found transactionId from state:', transactionId);
      }
      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô state ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
      if (!transactionId) {
        const txMatch = reportMessage.match(/TX[a-z0-9]+-[A-Z0-9]+/i);
        if (txMatch) {
          transactionId = txMatch[0].toUpperCase();
          console.log('Found transactionId from message:', transactionId);
        }
      }
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ transaction ‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
      if (transactionId) {
        const transaction = await Transaction.findOne({ 
          transactionId,
          $or: [{ sellerId: senderId }, { buyerId: senderId }]
        });
      if (!transaction) {
        await facebookService.sendMessage(
          senderId,
          `‚ö†Ô∏è ‡∏û‡∏ö Transaction ID: ${transactionId} ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì\n\n` +
          `üìã ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏µ Transaction ID`
        );
        transactionId = null;
      }
    }
      await reportService.startNewReport(senderId, reportMessage, transactionId);
      return;
    }
    else if (message.startsWith('/reply')) {
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      if (senderId !== process.env.ADMIN_FB_ID) {
        await facebookService.sendMessage(senderId, '‚ùå ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
        return;
      }
      
      const parts = message.split(' ');
      if (parts.length < 3) {
        await facebookService.sendMessage(
          senderId,
          '‚ùå ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á\n\n' +
          'üí° ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: /reply CASE-1234abc ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö'
        );
        return;
      }
      
      const caseId = parts[1];
      const replyMessage = parts.slice(2).join(' ');
      
      await reportService.addAdminMessage(senderId, caseId, replyMessage);
      return;
    }
    else if (message.startsWith('/listreports')) {
      try {
        const reports = await reportService.getReportHistory(senderId, 5);
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ reports ‡πÄ‡∏õ‡πá‡∏ô array ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        if (!reports || reports.length === 0) {
          await facebookService.sendMessage(
            senderId,
            'üìã ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤\n\n' +
            'üí° ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢ /report [‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏±‡∏ç‡∏´‡∏≤]'
          );
          return;
        }
        
        let message = `üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤ (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ${reports.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£):\n\n`;
        
        reports.forEach((report, index) => {
          const statusEmoji = report.status === 'open' ? 'üîì' : 'üîí';
          const firstMessage = report.messages && report.messages[0] ? report.messages[0].text : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°';
          message += `${index + 1}. ${statusEmoji} ${report.caseId}\n`;
          message += `   üìù ${firstMessage.substring(0, 30)}${firstMessage.length > 30 ? '...' : ''}\n`;
          message += `   üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${report.status === 'open' ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î'}\n`;
          message += `   ‚è∞ ${new Date(report.createdAt).toLocaleDateString('th-TH')}\n\n`;
        });
        
        message += 'üí° ‡∏õ‡∏¥‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏ß‡∏¢: /close CASE-ID';
        
        await facebookService.sendMessage(senderId, message);
      } catch (error) {
        console.error('List reports error:', error);
        await facebookService.sendMessage(
          senderId, 
          '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô\n\n' +
          'üìû ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ support'
        );
      }
      return;
    }
    else if (message.startsWith('/close')) {
      const caseId = message.replace('/close', '').trim();
      
      if (!caseId) {
        // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏´‡∏≤ case ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà
        const openCase = await reportService.hasOpenReport(senderId);
        if (openCase) {
          await reportService.closeReport(senderId, openCase.caseId);
        } else {
          await facebookService.sendMessage(
            senderId,
            '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà\n\n' +
            'üí° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ Case ID: /close CASE-1234abc'
          );
        }
        return;
      }
      
      await reportService.closeReport(senderId, caseId);
      return;
    }
    const openCase = await reportService.hasOpenReport(senderId);
    if (openCase && !message.startsWith('/')) {
      // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
      await reportService.addUserMessage(senderId, openCase.caseId, message);
      return;
    }
    else {
      const state = stateService.getState(senderId);
      if (state?.state === 'awaiting_game_details') {
        await transactionService.handleGameDetails(senderId, message);
      }
      else if (message.includes('|') && message.split('|').length === 3) {
        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£
        await transactionService.notifyAdminForSellerPayment(senderId, message);
      }
      else {
        // ‡∏™‡πà‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å
        if (message.match(/^TX[A-Z0-9]/i)) {
          return
        }
        await facebookService.sendButtonTemplate(
          senderId,
          `ü§ñ ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏Å‡∏°\n\n` +
          `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£:`,
          [
            { type: "postback", title: "üéÆ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏•‡∏≤‡∏á", payload: "START_SELLING" },
            { type: "postback", title: "üìû ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤", payload: "REPORT_ISSUE" },
            { type: "postback", title: "‚ÑπÔ∏è ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ", payload: "HOW_TO_USE" }
          ]
        );
      }
    }
  } catch (error) {
    console.error('Message handling error:', error);
    await facebookService.sendMessage(senderId, 
      `‚ùå ${error.message}\n\n` +
      `üí¨ ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ support`
    );
  }
};

const handlePostback = async (senderId, postback) => {
  const payload = postback.payload;
  
  console.log('Received postback:', { senderId, payload });
  
  try {
    if (payload.startsWith('PAY_NOW_')) {
      const transactionId = payload.replace('PAY_NOW_', '');
      if (!transactionId || transactionId === 'PAY_NOW_') {
        throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö Transaction ID');
      }
      console.log('Processing PAY_NOW for transaction:', transactionId);
      await transactionService.handlePaymentRequest(senderId, transactionId);
    }
    else if (payload.startsWith('PAYMENT_CONFIRMED_')) {
      const transactionId = payload.replace('PAYMENT_CONFIRMED_', '');
      console.log('üí≥ Processing PAYMENT_CONFIRMED for transaction:', transactionId);
      
      // ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô
      await facebookService.sendMessage(senderId,
        `‚úÖ ‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô\n\n` +
        `üì∏ **‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πà‡∏á‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô** ‡∏°‡∏≤‡∏ó‡∏≤‡∏á‡πÅ‡∏ä‡∏ó‡∏ô‡∏µ‡πâ\n` +
        `‚Ä¢ ‡∏™‡∏Å‡∏£‡∏µ‡∏ô‡∏ä‡πá‡∏≠‡∏ï‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡πÅ‡∏≠‡∏õ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£\n` +
        `‚Ä¢ ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô\n\n` +
        `‚ö†Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô`
      );
      
      stateService.setState(senderId, 'awaiting_payment_proof', { transactionId });
    }
    else if (payload.startsWith('ADMIN_CONFIRM_PAYMENT_')) {
      const transactionId = payload.replace('ADMIN_CONFIRM_PAYMENT_', '');
      await handleAdminPaymentConfirmation(senderId, transactionId);
      console.log('Admin confirmed payment for transaction:', transactionId);
      await transactionService.handleAdminPaymentConfirmation(transactionId);
    }
    else if (payload.startsWith('ADMIN_REJECT_PAYMENT_')) {
      const transactionId = payload.replace('ADMIN_REJECT_PAYMENT_', '');
      await handleAdminPaymentRejection(senderId, transactionId);
      console.log('Admin rejected payment for transaction:', transactionId);
      // TODO: ‡∏≠‡∏≤‡∏à‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á buyer + seller ‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô
      await facebookService.sendMessage(senderId,
        `‚ùå ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏° ${transactionId} ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á\n\n` +
        `üìû ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ support ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏ó‡∏µ‡πà Line : @gameruleTh`
      );
    }
    else if (payload.startsWith('DELIVERED_')) {
      const transactionId = payload.replace('DELIVERED_', '');
      console.log('üöö Processing DELIVERED for transaction:', transactionId);
      await transactionService.handleDeliveryConfirmation(senderId, transactionId);
    }
    else if (payload.startsWith('CONFIRM_RECEIPT_')) {
      const transactionId = payload.replace('CONFIRM_RECEIPT_', '');
      console.log('‚úÖ Processing CONFIRM_RECEIPT for transaction:', transactionId);
      await transactionService.handleBuyerConfirmation(senderId, transactionId);
    }
    else if (payload.startsWith('REPORT_PAYMENT_')) {
      const transactionId = payload.replace('REPORT_PAYMENT_', '');
      
      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å transactionId ‡πÉ‡∏ô state
      stateService.setState(senderId, 'reporting_issue', { transactionId });
      
      await facebookService.sendMessage(
        senderId,
        `üìû ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô\n\n` +
        `üìã Transaction ID: ${transactionId}\n\n` +
        `üí¨ ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏û‡∏ö:\n` +
        `‚Ä¢ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡πÑ‡∏î‡πâ\n` +
        `‚Ä¢ ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô\n` +
        `‚Ä¢ ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ\n\n` +
        'üìù ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á /report\n\n' +
        'üí° ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: /report ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ'
      );
    }
    else if (payload.startsWith('ADMIN_PAID_SELLER_')) {
      const transactionId = payload.replace('ADMIN_PAID_SELLER_', '');
      await handleAdminPaymentToSeller(senderId, transactionId);
    }
    else if (payload.startsWith('ADMIN_PAYMENT_PROBLEM_')) {
      const transactionId = payload.replace('ADMIN_PAYMENT_PROBLEM_', '');
      await handleAdminPaymentProblem(senderId, transactionId);
    }
    else if (payload.startsWith('NOT_ACCOUT_')) {
      const transactionId = payload.replace('NOT_ACCOUT_', '');
      const userId = await Transaction.findOne( {transactionId : transactionId} )
      // ‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢
      await facebookService.sendMessage( userId.sellerId,
        `‚ùå ‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏à‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì\n\n` +
        `‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πà‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ`
      )
      // ‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠
      await facebookService.sendButtonTemplate( userId.buyerId,
        `‚ùóÔ∏è ‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß\n\n` +
        `‚ö†Ô∏è ‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏µ‡∏Å ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏Ç‡∏≠‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô" ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô\n\n`,
          [
            { type: "postback", title: "üí∏ ‡∏Ç‡∏≠‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô", payload: `REFUN_${transactionId}` }
          ]
      )
    }
    else if (payload.startsWith('REFUN_')) {
      const transactionId = payload.replace('REFUN_', '');
      const userId = await Transaction.findOne( {transactionId : transactionId} )
      // ‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢
      await facebookService.sendMessage( userId.sellerId,
        `‚ùå ‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏à‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì\n\n` +
        `‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πà‡∏á‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏≤‡∏á Line: @gameruleTh ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏´‡∏±‡∏™ Transaction ID\n\n` +
        `‚ùóÔ∏è ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 5 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡πâ‡∏à‡∏£‡∏¥‡∏á ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢‡∏ô‡∏µ‡πâ\n\n`
      )
      // ‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠
      await facebookService.sendMessage( userId.buyerId,
        `‚ö†Ô∏è ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢\n\n` +
        `‚ùóÔ∏è ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì\n\n` +
        `‚ùóÔ∏è ‡∏´‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏ß‡πà‡∏≤ ‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏à‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ\n\n` +
        `‚úÖ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ"\n\n` +
        `üìù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏à‡πâ‡∏á\n` +
        `‡πê‡∏ä‡∏∑‡πà‡∏≠‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£\n` +
        `‡πê‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ\n` +
        `‡πê‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ\n\n` +
        `üí° ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: "‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢ 04412345678 ‡∏™‡∏°‡∏ä‡∏≤‡∏¢"` 
      )
      // ‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
      await facebookService.sendButtonTemplate( process.env.ADMIN_FB_ID,
        `‚ö†Ô∏è ‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô\n\n` +
        `Transaction ID: ${transactionId}\n\n` + 
        `‚ùóÔ∏è ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡πÉ‡∏ô Line\n\n` +
        `‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó‡πÄ‡∏û‡∏à`,
        [
          { type: "postback", title: "‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°", payload: `CANCELLED_${transactionId}` }
        ]
      )
    }
    else if (payload.startsWith('CANCELLED_')) {
      const transactionId = payload.replace('CANCELLED_', '');
      const transaction = await Transaction.findOne({ transactionId : transactionId})
      console.log(transactionId)
      if (!transaction) {
        console.error("‚ùå Transaction not found for transactionId:", transactionId);
        await facebookService.sendMessage(senderId, "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏î‡∏µ‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
        return;
      }
      transaction.status = 'cancelled';
      transaction.cancelledAt = new Date();
      await transaction.save();
        // ‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢
      await facebookService.sendMessage( transaction.sellerId,
        `‚ùå ‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß\n`
      )
        // ‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠
      await facebookService.sendMessage( transaction.buyerId,
        `‚ùå ‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß\n`
      )
        // ‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
      await facebookService.sendMessage( process.env.ADMIN_FB_ID,
         `‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°\n\n` +
         `Transaction ID : ${transactionId}`
      )
    }
    else if (payload.startsWith('UPLOAD_PROOF_')) {
      const transactionId = payload.replace('UPLOAD_PROOF_', '');
      if (!transactionId || transactionId === 'UPLOAD_PROOF_') {
        throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö Transaction ID');
      }
      console.log('Processing UPLOAD_PROOF for transaction:', transactionId);
      await facebookService.sendMessage(senderId,
        `üì∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πà‡∏á‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô\n\n` +
        `‚ö†Ô∏è ‡∏™‡πà‡∏á‡∏†‡∏≤‡∏û‡∏™‡∏Å‡∏£‡∏µ‡∏ô‡∏ä‡πá‡∏≠‡∏ï‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏≤‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó‡∏ô‡∏µ‡πâ`
      );
      stateService.setState(senderId, 'awaiting_payment_proof', { transactionId });
    }
    else if (payload === 'START_SELLING') {
      await transactionService.startSellerFlow(senderId);
    }
    else if (payload === 'HOW_TO_USE') {
      await facebookService.sendMessage(
        senderId,
        `üìñ ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö:\n\n` +
        `1. ‡∏Å‡∏î "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏•‡∏≤‡∏á" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡∏°‡πà\n` +
        `2. ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏Å‡∏°\n` +
        `3. ‡πÅ‡∏ä‡∏£‡πå Transaction ID ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠\n` +
        `4. ‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡πà‡∏á Transaction ID ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°\n` +
        `5. ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö\n` +
        `6. ‡∏™‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ\n\n` +
        `üìû ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤:\n` +
        `‚Ä¢ ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á /report [‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏±‡∏ç‡∏´‡∏≤]\n` +
        `‚Ä¢ ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: /report ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ\n` +
        `‚Ä¢ ‡∏õ‡∏¥‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: /close\n\n` +
        `üí∞ ‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£: 50 ‡∏ö‡∏≤‡∏ó/‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°`
      );
    }
    else if (payload === 'REPORT_ISSUE') {
      await facebookService.sendMessage(
        senderId,
        `üìû ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤\n\n` +
        `üí¨ ‡∏´‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£\n` +
        `‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏£‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á:\n\n` +
        `üîß /report [‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏±‡∏ç‡∏´‡∏≤]\n` +
        `üí° ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: /report ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ\n\n` +
        `üìã ‡∏´‡∏≤‡∏Å‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°\n` +
        `‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏ Transaction ID ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°\n\n` +
        `üõ†Ô∏è ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏à‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ`
      );
    }
    else if (payload === 'CONTACT_SUPPORT') {
      await facebookService.sendMessage(senderId,
        `üìû ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Support:\n\n` +
        `‚Ä¢ Line: @gameruleTh\n` +
        `‚Ä¢ ‡πÇ‡∏ó‡∏£: 064-526-5274\n\n` +
        `üïí ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£: 09:00-23:00 ‡∏ô.`
      );
    }
  } catch (error) {
    console.error('Postback handling error:', error);
    await facebookService.sendMessage(senderId,
      `‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}\n\n` +
      `üí¨ ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ support`
    );
  }
};

const handleAdminPaymentConfirmation = async (adminId, transactionId) => {
  try {
    const transaction = await Transaction.findOne({ transactionId });
    
    if (!transaction) {
      throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ');
    }

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
    transaction.paymentVerification = {
      verified: true,
      verifiedBy: adminId,
      verifiedAt: new Date(),
      notes: '‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÇ‡∏î‡∏¢‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô'
    };
    transaction.status = 'paid';
    transaction.paidAt = new Date();
    await transaction.save();

    // ‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
    await facebookService.sendMessage(adminId,
      `‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢\n\n` +
      `üìã Transaction ID: ${transactionId}\n` +
      `üí∞ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${transaction.paymentAmount} ‡∏ö‡∏≤‡∏ó\n\n` +
      `üìß ‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`
    );

  } catch (error) {
    console.error('Admin payment confirmation error:', error);
  }
};

  const handleAdminPaymentToSeller = async (adminId, transactionId) => {
    try {
      const transaction = await Transaction.findOne({ transactionId });
      
      if (!transaction) {
        throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ');
      }

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô completed
      transaction.status = 'completed';
      transaction.completedAt = new Date();
      await transaction.save();

      // ‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢
      await facebookService.sendMessage(transaction.sellerId,
        `üéâ ‡πÇ‡∏õ‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì!\n\n` +
        `‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß\n` +
        `üí∞ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${transaction.gameDetails.price} ‡∏ö‡∏≤‡∏ó\n` +
        `üè¶ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: ${transaction.sellerBankInfo.bankName}\n\n` +
        `‚≠ê ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£`
      );

      // ‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
      await facebookService.sendMessage(adminId,
        `‚úÖ ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢\n\n` +
        `üìã Transaction ID: ${transactionId}\n` +
        `üí∞ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${transaction.gameDetails.price} ‡∏ö‡∏≤‡∏ó\n` +
        `üë§ ‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢: ${transaction.sellerBankInfo.accountName}`
      );

    } catch (error) {
      console.error('Admin payment to seller error:', error);
      await facebookService.sendMessage(adminId, `‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`);
    }
  };

const handleAdminPaymentProblem = async (adminId, transactionId) => {
  try {
    await facebookService.sendMessage(adminId,
      `‚ùå ‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô\n\n` +
      `üìã Transaction ID: ${transactionId}\n\n` +
      `üõ†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ó‡∏µ‡∏° support ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ manually`
    );
  } catch (error) {
    console.error('Admin payment problem error:', error);
  }
};

const handlePaymentProof = async (senderId, attachments) => {
  try {
    const imageUrl = attachments[0].payload.url;
    
    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ transaction ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
    const transaction = await Transaction.findOne({
      buyerId: senderId,
      status: 'waiting_payment'
    }).sort({ createdAt: -1 });

    if (!transaction) {
      throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô');
    }

    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£ detect
    await facebookService.sendMessage(
      senderId,
      'üì∏ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô...'
    );

    // ‡πÉ‡∏ä‡πâ paymentService ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô
    await paymentService.handlePaymentWithProof(senderId, transaction.transactionId, imageUrl);

  } catch (error) {
    console.error('Handle payment proof error:', error);
    await facebookService.sendMessage(
      senderId,
      `‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}\n\n` +
      `üí¨ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ support ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤`
    );
  }
};

module.exports = { handleWebhook };